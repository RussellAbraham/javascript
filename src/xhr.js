// data : application / octet-stream ; base64 , JTIyJTdCJTIwJTVDJTIyZWxlbWVudHMlNUMlMjIlM0ElMjAlNUIlMjAlN0IlMjAlNUMlMjJuYW1lJTVDJTIyJTNBJTIwJTVDJTIySHlkcm9nZW4lNUMlMjIlMkMlMjAlNUMlMjJhcHBlYXJhbmNlJTVDJTIyJTNBJTIwJTVDJTIyY29sb3JsZXNzJTIwZ2FzJTVDJTIyJTJDJTIwJTVDJTIyYXRvbWljX21hc3MlNUMlMjIlM0ElMjAxLjAwOCUyQyUyMCU1QyUyMmJvaWwlNUMlMjIlM0ElMjAyMC4yNzElMkMlMjAlNUMlMjJjYXRlZ29yeSU1QyUyMiUzQSUyMCU1QyUyMmRpYXRvbWljJTIwbm9ubWV0YWwlNUMlMjIlMkMlMjAlNUMlMjJjb2xvciU1QyUyMiUzQSUyMG51bGwlMkMlMjAlNUMlMjJkZW5zaXR5JTVDJTIyJTNBJTIwMC4wODk4OCUyQyUyMCU1QyUyMmRpc2NvdmVyZWRfYnklNUMlMjIlM0ElMjAlNUMlMjJIZW5yeSUyMENhdmVuZGlzaCU1QyUyMiUyQyUyMCU1QyUyMm1lbHQlNUMlMjIlM0ElMjAxMy45OSUyQyUyMCU1QyUyMm1vbGFyX2hlYXQlNUMlMjIlM0ElMjAyOC44MzYlMkMlMjAlNUMlMjJuYW1lZF9ieSU1QyUyMiUzQSUyMCU1QyUyMkFudG9pbmUlMjBMYXZvaXNpZXIlNUMlMjIlMkMlMjAlNUMlMjJudW1iZXIlNUMlMjIlM0ElMjAxJTJDJTIwJTVDJTIycGVyaW9kJTVDJTIyJTNBJTIwMSUyQyUyMCU1QyUyMnBoYXNlJTVDJTIyJTNBJTIwJTVDJTIyR2FzJTVDJTIyJTJDJTIwJTVDJTIyc291cmNlJTVDJTIyJTNBJTIwJTVDJTIyaHR0cHMlM0ElMkYlMkZlbi53aWtpcGVkaWEub3JnJTJGd2lraSUyRkh5ZHJvZ2VuJTVDJTIyJTJDJTIwJTVDJTIyc3BlY3RyYWxfaW1nJTVDJTIyJTNBJTIwJTVDJTIyaHR0cHMlM0ElMkYlMkZlbi53aWtpcGVkaWEub3JnJTJGd2lraSUyRkZpbGUlM0FIeWRyb2dlbl9TcGVjdHJhLmpwZyU1QyUyMiUyQyUyMCU1QyUyMnN1bW1hcnklNUMlMjIlM0ElMjAlNUMlMjJIeWRyb2dlbiUyMGlzJTIwYSUyMGNoZW1pY2FsJTIwZWxlbWVudCUyMHdpdGglMjBjaGVtaWNhbCUyMHN5bWJvbCUyMEglMjBhbmQlMjBhdG9taWMlMjBudW1iZXIlMjAxLiUyMFdpdGglMjBhbiUyMGF0b21pYyUyMHdlaWdodCUyMG9mJTIwMS4wMDc5NCUyMHUlMkMlMjBoeWRyb2dlbiUyMGlzJTIwdGhlJTIwbGlnaHRlc3QlMjBlbGVtZW50JTIwb24lMjB0aGUlMjBwZXJpb2RpYyUyMHRhYmxlLiUyMEl0cyUyMG1vbmF0b21pYyUyMGZvcm0lMjAoSCklMjBpcyUyMHRoZSUyMG1vc3QlMjBhYnVuZGFudCUyMGNoZW1pY2FsJTIwc3Vic3RhbmNlJTIwaW4lMjB0aGUlMjBVbml2ZXJzZSUyQyUyMGNvbnN0aXR1dGluZyUyMHJvdWdobHklMjA3NSUyNSUyMG9mJTIwYWxsJTIwYmFyeW9uaWMlMjBtYXNzLiU1QyUyMiUyQyUyMCU1QyUyMnN5bWJvbCU1QyUyMiUzQSUyMCU1QyUyMkglNUMlMjIlMkMlMjAlNUMlMjJ4cG9zJTVDJTIyJTNBJTIwMSUyQyUyMCU1QyUyMnlwb3MlNUMlMjIlM0ElMjAxJTJDJTIwJTVDJTIyc2hlbGxzJTVDJTIyJTNBJTIwJTVCJTIwMSUyMCU1RCUyQyUyMCU1QyUyMmVsZWN0cm9uX2NvbmZpZ3VyYXRpb24lNUMlMjIlM0ElMjAlNUMlMjIxczElNUMlMjIlMkMlMjAlNUMlMjJlbGVjdHJvbl9hZmZpbml0eSU1QyUyMiUzQSUyMDcyLjc2OSUyQyUyMCU1QyUyMmVsZWN0cm9uZWdhdGl2aXR5X3BhdWxpbmclNUMlMjIlM0ElMjAyLjIwJTJDJTIwJTVDJTIyaW9uaXphdGlvbl9lbmVyZ2llcyU1QyUyMiUzQSUyMCU1QiUyMDEzMTIuMCUyMCU1RCUyMCU3RCUyMCU1RCUyMCU3RCUyMg==

window.addEventListener('load', function(){
	
	const worker = new Worker(URL.createObjectURL(new Blob(['self.onmessage=function(event){postMessage(event.data, [event.data]);}'],{type:'text/javascript'})))
	
	const composite = 'data:application/json, '.concat( encodeURIComponent ( JSON.stringify([{
    "elements": [
        {
            "name": "Hydrogen", 
            "appearance": "colorless gas", 
            "atomic_mass": 1.008, 
            "boil": 20.271, 
            "category": "diatomic nonmetal", 
            "color": null, 
            "density": 0.08988, 
            "discovered_by": "Henry Cavendish", 
            "melt": 13.99, 
            "molar_heat": 28.836, 
            "named_by": "Antoine Lavoisier", 
            "number": 1, 
            "period": 1, 
            "phase": "Gas", 
            "source": "https://en.wikipedia.org/wiki/Hydrogen", 
            "spectral_img": "https://en.wikipedia.org/wiki/File:Hydrogen_Spectra.jpg", 
            "summary": "Hydrogen is a chemical element with chemical symbol H and atomic number 1. With an atomic weight of 1.00794 u, hydrogen is the lightest element on the periodic table. Its monatomic form (H) is the most abundant chemical substance in the Universe, constituting roughly 75% of all baryonic mass.", 
            "symbol": "H", 
            "xpos": 1, 
            "ypos": 1, 
            "shells": [
                1
            ],
            "electron_configuration": "1s1",
            "electron_affinity": 72.769,
            "electronegativity_pauling": 2.20,
            "ionization_energies": [
                1312.0
            ]
        }
    ]

	}]) ) );
	
	const request = new XMLHttpRequest();
	const reader = new FileReader();
	const pre = document.querySelector('pre');
	
	var blob = null;
	
	request.open('GET',  composite, true);
	request.responseType = 'arraybuffer';
	
	worker.addEventListener('message', function(event){
		
		console.log.apply(this, arguments);
		
		const fragment = document.createDocumentFragment();
		
		fragment.appendChild(document.createTextNode(event.data));
		
		reader.addEventListener('load', function(event){			
			
			fragment.appendChild(document.createTextNode(reader.result));		
			
			pre.appendChild(fragment);
			
		}, false);
		
		reader.readAsBinaryString(new Blob([event.data], {type:'application/json'}));	
		
	});
	
	request.addEventListener('readystatechange', function(){
		console.log(this.getAllResponseHeaders());
	}, false);
	
	request.addEventListener('load', function(){
		worker.postMessage(this.response, [this.response]);		
	}, false);
	
	request.send(null);
	
}, false);

/**/

window.addEventListener('load', function(){
	
	const worker = new Worker(URL.createObjectURL(new Blob(['self.onmessage=function(event){postMessage(event.data, [event.data]);}'],{type:'text/javascript'})))
	
	const composite = 'data:application/json, '.concat( encodeURIComponent ( JSON.stringify([
		/* mock data */
		{0:null}
	]) ) );
	
	const request = new XMLHttpRequest();
	
	request.open('GET',  composite, true);
	request.responseType = 'arraybuffer';
	
	worker.addEventListener('message', function(event){
		console.log(event.data);
	});
	
	request.addEventListener('readystatechange', function(){
		console.log(this.getAllResponseHeaders());
	}, false);
	
	request.addEventListener('load', function(){
		worker.postMessage(this.response, [this.response]);		
	}, false);
	
	request.send(null);
	
}, false);
/* */

	

function Xtor(){
	this.request = new XMLHttpRequest();
	this.request.addEventListener('error', this.onRequestError.bind(this, true), false);
	this.request.addEventListener('load', this.onRequestLoad.bind(this, true), false);		
	this.request.addEventListener('readystatechange', this.onReadyStateChange.bind(this, true), false);		
}	
Xtor.prototype = {
	get : function(options){
		options = (options || {});
		this.request.open('GET', options.url, true);
		this.request.responseType = options.type;
		this.request.send(null);			
	},
	onRequestError : function(event){},
	onRequestLoad : function(event){
		console.log(this.request.response);
	},
	onReadyStateChange : function(event){
		if(this.request.readyState === this.request.HEADERS_RECEIVED){
			var headers = this.request.getAllResponseHeaders();
			console.log(headers);
		}
	}
};

/*-----------------------------------------------*/

const assets = 'https://s3-us-west-2.amazonaws.com/s.cdpn.io/1674766/';

function loadResource(options) {
	options = (options || {});
	return new Promise(function (resolve, reject) {		
		var request = new XMLHttpRequest();		
		request.open("GET", assets + options.url, true);	
		request.responseType = options.type;
		
		request.onreadystatechange = function(){
			if(this.readyState === this.HEADERS_RECEIVED){
				console.info(request.getAllResponseHeaders());
			}    
		}
		
		request.onload = function () {		
			if (request.status === 200) {			
				resolve(request.response);	
			} else {			
				reject( Error(request.statusText) );			
			}				
		};
		
		request.onerror = function () {
			reject(Error("request failed: "));
		};		
		
		request.send(null);		
		
	});	
}

// example
/*
loadResource({ url : 'types.json', type : 'text' })
.then(function(response){ 
	console.log(Object.keys(JSON.parse(response)));
	console.log(Object.values(JSON.parse(response))); 
})
.catch(function(er){
	console.log(er.stack)
})
*/

/*-----------------------------------------------*/

const request = new XMLHttpRequest();

function loadJson() {
    request.open();
    request.send();
    request.onload = function () {
        if (request.status === 200) {
            return request.response;
        } else {
            throw new Error('could not GET');
        }
    }
}

function readyJson() {
    request.onreadystatechange = function (response) {
        if (request.resopnse === 4) {
            if (request.status === 200) {

            } else {

            }
        }
    }
}

function fetchBlob() {
    request.open();
    request.responseType = 'blob';
    request.onload - function () {
        if (request.status === 200) {
            var blob = URL.createObjectURL(request.response);
            return blob;
        } else {
            throw new Error('')
        }
    }
}

function extend(object, props){
	for(var prop in props){
		if(props[prop]){
			object[prop] = props[prop]
		}
	}
	return object;
}

function listen(object, events){
	for(var event in events){
		object.addEventListener(event, events[event])
	}
}

/*-----------------------------------------------*/

/* 
(function(platform){

	// redirect bb10 browser to media stream fallback ( deprecated )
	
	function Ctor(){
		this.check();
	}

	Ctor.prototype = {
	
		Win32 : function(){
			location.href = 'a/';
		},
		
		BlackBerry : function(){
			location.href = 'b/';
		},
		
		check : function(){
			var self = this;
			switch(platform){
				case 'BlackBerry' : self.BlackBerry(); break;
				case 'Win32' : self.Win32(); break;
			}
		}
	
	}

})(navigator.platform);

function Ctor(options){
	options = options || {};
	this.node = options.node;
	this.isActive = false;
}
Ctor.prototype = {
	on:function(){
		this.isActive = true;
	},
	off:function(){
		this.isActive = false;
	},
	toggle:function(){
		return this.check() ? this.off() : this.on()
	},
	check:function(){
		return this.isActive;
	}
}
*/

/*-----------------------------------------------*/

function Ajax(){
	this.transport = new XMLHttpRequest();
	this.data = new FormData();
}

Ajax.prototype = {
	
	get : function(options){	
		
		var self = this;				
		
		this.options = extend({ 
			url : '', 
			responseType : '' 
		}, options);		
		
		listen(this.transport, {			
			
			'readystatechange' : function(){
				if (this.readyState == this.HEADERS_RECEIVED) {			
					var headers = request.getAllResponseHeaders();			
					var arr = headers.trim().split(/[\r\n]+/);			
					var headerMap = {};			
					arr.forEach(function (line) {				
						var parts = line.split(': ');				
						var header = parts.shift();				
						var value = parts.join(': ');				
						headerMap[header] = value;			
					});		
				}				
			},
			
			'error' : function(event){},
			
			'load' : function(){						
				if(this.transport.status === 200){  
					// ok
				} else {
					// handle error
				}
			}	
			
		});
		
		this.transport.open('GET', self.options.url, true);
		this.transport.responseType = self.options.responseType;
		this.transport.send(null);
		
	},
	
	post : function(){
		this.data.append('', '');
		this.data.append('', '');
		this.data.append('', '');
		// 
		this.transport.open('POST', '');		
		this.transport.send(this.data);
	}
	
}

/*-----------------------------------------------*/

function Index(db){
	this.db = db;
}

Index.prototype = {
	
	// handle errors.. check how to handle upgrades and versions
	open : function(){},
	
	// create and add new object
	create : function(){},

	// iterate over key values
	read : function(){},

	// put new value then resolve
	update : function(){},
	
	// delete single item by UID
	destroy : function(){},
	
	// output a json file backup
	export : function(){},
	
	// json data from XHR
	import : function(){},
	
	// json data from file input
	upload : function(){}
	
}


var request, response, blob;


function getjson(url){
	// assing instance
	request = new XMLHttpRequest();      
	// open "GET" request
	request.open('GET', url);        
	// responseType text is for legacy with 'json' resopnse type
	request.responseType = 'text';        
	//
	request.onload = function(){        
		
		if(request.status === 200){                
			response = JSON.parse(request.response);                
			populate(response);            
		} else {
			console.warn('Network request failed ' + request.status + ':' + request.statusText);            
		}        
	}
	request.send();
}
    
function getjson2(url){
	
	request = new XMLHttpRequest();        
        request.open("GET", url);
        request.responseType = 'text';
	
	request.onreadystatechange = function(){
            if(this.readyState === this.HEADERS_RECEIVED){
                var headers = request.getAllResponseHeaders();
                console.log(headers);
            }
        }
	
        request.onload = function(){
            response = JSON.parse(request.response);
            populate(response);
        }
	

	request.send();
    
}

// GET request for Blob Data
function getimg(url){
        request = new XMLHttpRequest();
        request.open('GET', url);
        request.responseType = 'blob';
        request.onload = function(){
            if(request.status === 200){
                response = request.response;
                blob = window.URL.createObjectURL(response);
                populate(blob);
            } else {
                console.info('Network request failed ' + request.status + ':' + request.statusText);            
            }
        }
        request.send();
    }

    function populate(obj){
        //self.postMessage(obj);
    }

})();

/*-----------------------------------------------*/

/* 
  core request response mechanism for 'paging' navigation 
  todo:
  bootstrap
*/

const xhr = new XMLHttpRequest();

xhr.open('GET', location, true);

// accepted mime type, default is *
xhr.setRequestHeader('ACCEPT', '*/*');

// 
xhr.setRequestHeader('X-CUSTOM', 'true');

xhr.onreadystatechange = function(){
	console.log(this.getAllResponseHeaders());
}

xhr.onload = function(){		
	
	const responseText = this.responseText;  	
	
	if (/<html/i.test(responseText)) {		
		history.pushState({
			head : responseText.match(/<head[^>]*>([\s\S.]*)<\/head>/i)[0],
			body : responseText.match(/<body[^>]*>([\s\S.]*)<\/body>/i)[0]
		},'test','test');		   
	} 	
	
	console.log(history.state);
	
}

xhr.send(null);

setTimeout(function(){
	history.back(1);
}, 200);
